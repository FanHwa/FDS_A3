---
jupyter:
  jupytext:
    text_representation:
      extension: .Rmd
      format_name: rmarkdown
      format_version: '1.2'
      jupytext_version: 1.16.4
  kernelspec:
    display_name: R
    language: R
    name: ir
---

## FIT5145: Foundations of Data Science Assignments 3: Business and Data Case Study

Student Name: Tan Fan Hwa

Student ID: 34648100

### 1.0 Introduction

This project is to anaylse a usable dataset from the Australian Government's Safe Work Australia website. The goal for this analysis is to prove the feasilbility of using the dataset to predict the number of injury claims in the future from different factors and provide a customisable insurance plan model based on diffreent customers' characteristics.

### 2.0 Load Library

```{r}
# Load Libraries
library(knitr)
library(tidyr)
library(ggplot2)
library(grid)
library(gridExtra)
library(dplyr)
library(tidyverse)
library(naniar)
library(reshape2)
library(caret)
library(readxl)
library(forecast)
library(reshape2)
```

### 3.0 Reading the Data and Preprocessing

```{r}
file_path = "Claims-statistical-report-calendar-year-2024-06.xlsx"

# List all sheets in the Excel file
sheet_names <- excel_sheets(file_path)
print("Dataset Sheet Names")
print(sheet_names)
```

#### 3.1 Industry Division Data

```{r}
# Read Industry division sheet
industry_division_df <- read_excel(file_path, sheet = "Industry division", skip = 10)

industry_division_df <- industry_division_df[, 1:14]

# Rename columns to proper names (as shown in the screenshot)
colnames(industry_division_df) <- c("industry_division", "2011", "2012", "2013", 
                               "2014", "2015", "2016", "2017", "2018", "2019", 
                               "2020", "2021", "2022", "2023")

# Convert column 2 to 14 as numeric
industry_division_df[, 2:14] <- sapply(industry_division_df[, 2:14], as.numeric)

# Remove the first letter in the data in the industry_division column which serves as a tag
industry_division_df$industry_division <- sub("^\\w\\s+", "", industry_division_df$industry_division)

# Drop any rows with all NA values
industry_division_df <- industry_division_df[complete.cases(industry_division_df), ]

industry_division_df
```

The `total` row will be removed from the data as it don't represent individual observations or unique categories. Including them in analysis (especially visualizations or correlations) can lead to misleading insights.

```{r}
# remove `total` row
industry_division_df <- industry_division_df[-nrow(industry_division_df), ]

industry_division_df
```

<!-- #region vscode={"languageId": "r"} -->

We will drop out the `Other Services` row as it is not representing any individual industry and cannot contribute to the analysis. <!-- #endregion -->

```{r}
# Drop Other Services row
industry_division_df <- industry_division_df[-which(industry_division_df$industry_division == "Other Services"), ]

industry_division_df
```

#### 3.2 Bodily Location Data

```{r}
# Read Bodily location sheet
bodily_location_df <- read_excel(file_path, sheet = "Bodily location", skip = 3)

bodily_location_df <- bodily_location_df[, 1:14]

# Rename columns to proper names (as shown in the screenshot)
colnames(bodily_location_df) <- c("bodily_location", "2011", "2012", "2013", 
                               "2014", "2015", "2016", "2017", "2018", "2019", 
                               "2020", "2021", "2022", "2023")

# Convert column 2 to 14 as numeric
bodily_location_df[, 2:14] <- sapply(bodily_location_df[, 2:14], as.numeric)

# Drop any rows with all NA values
bodily_location_df <- bodily_location_df[complete.cases(bodily_location_df), ]

# Remove leading numbers from the bodily_location column
bodily_location_df$bodily_location <- sub("^\\d+\\s+", "", bodily_location_df$bodily_location)

# Drop rows with `total` in the bodily_location column
bodily_location_df <- bodily_location_df[!grepl("Total", bodily_location_df$bodily_location, ignore.case = TRUE), ]

bodily_location_df
```

We will drop out the `Unspecified Location` row as it is not representing any individual location and cannot contribute to the analysis.

```{r}
# Drop rows with `Unspecified Location` in the bodily_location column
bodily_location_df <- bodily_location_df[!grepl("Unspecified Location", bodily_location_df$bodily_location, ignore.case = TRUE), ]

bodily_location_df
```

#### 3.3 Agency of Injury

```{r}
# Read Agency of injury data
agency_of_injury_df <- read_excel(file_path, sheet = "Agency of injury", skip = 10)

agency_of_injury_df <- agency_of_injury_df[, 1:15]

# Rename columns to proper names
colnames(agency_of_injury_df) <- c("agency_of_injury_type","agency_of_injury", "2011", "2012", "2013", 
                               "2014", "2015", "2016", "2017", "2018", "2019", 
                               "2020", "2021", "2022", "2023")

agency_of_injury_df <- agency_of_injury_df %>% fill(agency_of_injury_type, .direction = "down")

# Remove the first digit and any following space in the 'agency_of_injury_type' column
agency_of_injury_df$agency_of_injury_type <- sub("^\\d+\\s+", "", agency_of_injury_df$agency_of_injury_type)

# Remove the first digit and any following space in the 'agency_of_injury' column
agency_of_injury_df$agency_of_injury <- sub("^\\d+\\s+", "", agency_of_injury_df$agency_of_injury)

# Reorder the columns to swap positions
agency_of_injury_df <- agency_of_injury_df %>%
  select(agency_of_injury, agency_of_injury_type, everything())

# Remove rows where 'agency_of_injury' is "Agency group total"
agency_of_injury_df <- agency_of_injury_df[agency_of_injury_df$agency_of_injury != "Agency group total", ]

# Drop any rows with all NA values
agency_of_injury_df <- agency_of_injury_df[complete.cases(agency_of_injury_df), ]

agency_of_injury_df
```

We will drop out the `agency_of_injury_type` with `Other And Unspecified Agencies` as it is not representing any individual agency and cannot contribute to the analysis.

```{r}
# drop rows with `Other And Unspecified Agencies` in `agency_of_injury_type` column
agency_of_injury_df <- agency_of_injury_df[!grepl("Other And Unspecified Agencies", agency_of_injury_df$agency_of_injury_type, ignore.case = TRUE), ]

agency_of_injury_df
```

### 4.0 Analysis on Average Number of Injury Claims by Industry Division

```{r}

# Calculate the average number of injury claims for each industry
average_industry_claims <- industry_division_df %>%
  rowwise() %>%
  mutate(Average_Claims = mean(c_across(`2011`:`2023`), na.rm = TRUE)) %>%
  ungroup()

# Sort the industries by the highest average number of claims
average_industry_claims <- average_industry_claims %>%
  arrange(desc(Average_Claims))

average_industry_claims
```

```{r, }
# Plot the industries with the highest average number of injury claims
ggplot(average_industry_claims, aes(x = reorder(industry_division, Average_Claims), y = Average_Claims, fill = Average_Claims)) +
  geom_bar(stat = "identity") +
  coord_flip() +  # Flip the chart to make it more readable
  scale_fill_gradient(low = "lightblue", high = "darkblue") +  # Use a color gradient for different bar colors
  labs(
    title = "Average Number of Injury Claims by Industry Division (2011-2023)",
    x = "Industry Division",
    y = "Average Number of Claims"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 14, face = "bold", hjust = 0.5),
    axis.text.x = element_text(size = 10),
    axis.text.y = element_text(size = 10),
    axis.title = element_text(size = 12)
  )
```

From the bar chart, it is evident that industries such as Manufacturing, Health Care and Social Assistance, and Construction have the highest average number of injury claims over the specified period.

To refine our focus, we will conduct an Interquartile Range (IQR) analysis on the Average Number of Injury Claims by Industry Division. This statistical technique helps identify a threshold for selecting industries that are worth considering for customized insurance models. If the injury claims number is too low, it is deemed not cost-effective for the insurance company to provide customised solutions due to the lower risk levels in those industries.

```{r}
# Calculate the Interquartile Range (IQR), Q1, and Q3
industry_claims_Q1 <- quantile(average_industry_claims$Average_Claims, 0.25, na.rm = TRUE)
industry_claims_Q3 <- quantile(average_industry_claims$Average_Claims, 0.75, na.rm = TRUE)
industry_claims_IQR_value <- industry_claims_Q3 - industry_claims_Q1

# Calculate the lower bound
industry_claims_lower_bound <- industry_claims_Q1 - 1.5 * industry_claims_IQR_value
industry_claims_upper_bound <- industry_claims_Q3 + 1.5 * industry_claims_IQR_value

# Step 4: Identify industries with injury rates below the lower bound (low-risk)
selected_industries <- average_industry_claims %>%
    filter(Average_Claims > industry_claims_Q1) %>%
    arrange(Average_Claims)

# Step 5: Store all relevant statistics in a summary table
iqr_summary <- data.frame(
    Statistic = c("Q1 (25th Percentile)", "Q3 (75th Percentile)", "Interquartile Range (IQR)", "Lower Bound", "Upper Bound"),
    Value = c(industry_claims_Q1, industry_claims_Q3, industry_claims_IQR_value, industry_claims_lower_bound, industry_claims_upper_bound)
)

# Print the summary table with IQR statistics
print("IQR Summary for Industry Injury Claims:")
iqr_summary

```

From the IQR Summary, it shown that the lower bound having value of -2131 which is an invalid value. Then we are selecting Q1 with a value of 426 which represents the top 75% of industries in terms of injury rates. This approach ensures that only industries with a relatively higher risk profile are considered for customization of insurance plans.

```{r}
# Visualization: Highlight industries above the Threshold
ggplot(average_industry_claims, aes(x = reorder(industry_division, Average_Claims), y = Average_Claims)) +
  geom_bar(stat = "identity", aes(fill = Average_Claims > industry_claims_Q1)) +
  coord_flip() +
  labs(
    title = "Industries above the Threshold (Q1)",
    x = "Industry Division",
    y = "Average Number of Claims"
  ) +
  scale_fill_manual(
    values = c("TRUE" = "red", "FALSE" = "blue"),
    name = "Threshold Status",
    labels = c("Above Threshold", "Below Threshold")
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 14, face = "bold", hjust = 0.5),
    axis.text.x = element_text(size = 10),
    axis.text.y = element_text(size = 10),
    axis.title = element_text(size = 12)
  )
```

From the graphs it shows that Electricity, **Electricity, Gas, Water, and Waste Services**, **Rental, Hiring and Real Estate Services**, **Financial and Insurance Services**, **Information Media and Telecommunications**, and **Mining** fall below the threshold value (Q1 = 426). Customer from these industry division can consider to be removed from the prediction model due to low injury rate.

### 5.0 Time Series Analysis on Industry Division

This time series analysis is performed to observe changes in injury claim numbers across different industry division. By examining these trends, we can determine whether injury rates are increasing or decreasing over time, which is crucial for guiding insurance companies' decision-making.

```{r}
# Initialize a dataframe to store trend information for each industry
trend_results <- data.frame(Industry = character(), Slope = numeric(), Trend = character(), stringsAsFactors = FALSE)

# Loop through each industry in the dataset
for (i in 1:nrow(industry_division_df)) {
  industry_name <- industry_division_df$industry_division[i]
  industry_data <- as.numeric(unlist(industry_division_df[i, -1]))

  # Create a time series object
  industry_ts <- ts(industry_data, start = 2011, frequency = 1)

  # Fit a linear model to the time series to calculate the slope of the trend
  trend_model <- lm(industry_data ~ I(2011:2023))
  slope <- coef(trend_model)[2]

  # Determine the trend direction
  trend_direction <- ifelse(slope > 0, "Increasing", "Decreasing")

  # Store the results in the trend_results dataframe
  trend_results <- rbind(trend_results, data.frame(Industry = industry_name, Slope = slope, Trend = trend_direction))
}

trend_results
```

```{r}
# Select the top 2 industries with the most increasing and most decreasing trends for detailed analysis
top_increasing_trends <- trend_results %>% arrange(desc(Slope)) %>% head(2)
top_decreasing_trends <- trend_results %>% arrange(Slope) %>% head(2)

# Combine the results for visualization
selected_industries <- rbind(top_increasing_trends, top_decreasing_trends)

# Plot the time series data for the selected industries
industry_ggplot_list <- list()

for (i in 1:nrow(selected_industries)) {
  industry_name <- selected_industries$Industry[i]
  industry_data <- as.numeric(unlist(industry_division_df[industry_division_df$industry_division == industry_name, -1]))
  industry_ts <- ts(industry_data, start = 2011, frequency = 1)

  # Create a data frame for ggplot
  plot_data <- data.frame(Year = 2011:2023, Claims = industry_data)

  # Generate the ggplot for each industry
  p <- ggplot(plot_data, aes(x = Year, y = Claims)) +
    geom_line(color = ifelse(selected_industries$Trend[i] == "Increasing", "blue", "red"), linewidth = 1.2) +
    geom_point(color = ifelse(selected_industries$Trend[i] == "Increasing", "blue", "red")) +
    geom_smooth(method = "lm", se = FALSE, linetype = "dashed", color = "black") +
    labs(
      title = paste(industry_name),
      subtitle = paste("Slope:", round(selected_industries$Slope[i], 2)),
      x = "Year",
      y = "Number of Claims"
    ) +
    theme_minimal()
  
  industry_ggplot_list[[i]] <- p
}

# Step 5: Display the plots for all selected bodily locations with an overall title
main_industry_title <- textGrob(
  "Time Series Analysis on Injury Claims by Industry Division",
  gp = gpar(fontsize = 16, fontface = "bold")
)

# Use grid.arrange to display the plots with the main title
grid.arrange(
  arrangeGrob(
    grobs = industry_ggplot_list,  # List of ggplots for bodily locations
    ncol = 2,                    # Number of columns in the grid
    top = main_industry_title      # Set the main title for the entire plot
  )
)
```

Industries like Health Care and Social Assistance (slope: 134.12) and Construction (slope: 102.55)) show a clear upward trend in the number of injury claims over the years. This indicates that these sectors are experiencing a rise in risk which suggest the insurance premium of customer in these 3 industries should increase.

In contrast, sectors such as Manufacturing (slope: -72.13) and Wholesale Trade (slope: -18.58) exhibit a downward trend, suggesting a reduction in injury claims over time. This suggest a discount can be give to customers in these 3 industries

### 6.0 Time Series Analysis on Bodily Location

This time series analysis is performed to observe changes in injury claim numbers across different bodily locations of injury. This analysis examines the trends in injury claims across different bodily locations over time, providing insights into which bodily locations should increase the coverage limit.

```{r}
# Initialize a dataframe to store trend information for each bodily location
bodily_trend_results <- data.frame(Bodily_Location = character(), Slope = numeric(), Trend = character(), stringsAsFactors = FALSE)

# Loop through each bodily location in the dataset
for (i in 1:nrow(bodily_location_df)) {
  bodily_name <- bodily_location_df$bodily_location[i]
  bodily_data <- as.numeric(unlist(bodily_location_df[i, -1]))  # Remove the bodily location name column

  # Create a time series object
  bodily_ts <- ts(bodily_data, start = 2011, frequency = 1)

  # Fit a linear model to the time series to calculate the slope of the trend
  trend_model <- lm(bodily_data ~ I(2011:2023))
  slope <- coef(trend_model)[2]  # Extract the slope of the trend

  # Determine the trend direction
  trend_direction <- ifelse(slope > 0, "Increasing", "Decreasing")

  # Store the results in the bodily_trend_results dataframe
  bodily_trend_results <- rbind(bodily_trend_results, data.frame(Bodily_Location = bodily_name, Slope = slope, Trend = trend_direction))
}

bodily_trend_results
```

```{r}
# Select the top 2 bodily locations with the most increasing to visualize for deeper analysis
top_increasing_bodily_trends <- bodily_trend_results %>% arrange(desc(Slope)) %>% head(2)

# Plot the time series data for the selected bodily locations
bodily_ggplot_list <- list()

for (i in 1:nrow(top_increasing_bodily_trends)) {
  bodily_name <- top_increasing_bodily_trends$Bodily_Location[i]
  bodily_data <- as.numeric(unlist(bodily_location_df[bodily_location_df$bodily_location == bodily_name, -1]))
  bodily_ts <- ts(bodily_data, start = 2011, frequency = 1)

  # Create a data frame for ggplot
  plot_data <- data.frame(Year = 2011:2023, Claims = bodily_data)

  # Generate the ggplot for each bodily location
  p <- ggplot(plot_data, aes(x = Year, y = Claims)) +
    geom_line(color = ifelse(top_increasing_bodily_trends$Trend[i] == "Increasing", "blue", "red"), size = 1.2) +
    geom_point(color = ifelse(top_increasing_bodily_trends$Trend[i] == "Increasing", "blue", "red")) +
    geom_smooth(method = "lm", se = FALSE, linetype = "dashed", color = "black") +
    labs(
      title = paste(bodily_name),
      subtitle = paste("Slope:", round(top_increasing_bodily_trends$Slope[i], 2)),
      x = "Year",
      y = "Number of Claims"
    ) +
    theme_minimal()
  
  bodily_ggplot_list[[i]] <- p
}

# Display the plots for all selected bodily locations with an overall title
main_bodily_title <- textGrob(
  "Time Series Analysis on Injury Claims by Bodily Location",
  gp = gpar(fontsize = 16, fontface = "bold")
)

# Use grid.arrange to display the plots with the main title
grid.arrange(
  arrangeGrob(
    grobs = bodily_ggplot_list,
    ncol = 2,
    top = main_bodily_title
  )
)
```

**Psychological System** (slope: 180.31) and **Ear** (slope: 90.36) injuries show significant upward trends, indicating a rising number of claims in these categories. This suggests that these types of injuries are becoming more common, potentially due to increasing awareness or recognition of psychological and hearing-related issues in the workplace. Insurance companies can consider in increase coverage limits for these bodily locations.

### 7.0 Correlation Analysis between Industry Division and Agency of Injury

In this analysis, we calculated the **correlation scores** between various **Industry Divisions** and their corresponding **Agencies of Injury** to determine the strength of the relationships between them.

```{r}
# Create an empty dataframe to store the correlation results
industry_agency_correlation_df <- data.frame(agency_of_injury = agency_of_injury_df$agency_of_injury)

# Loop through each industry division and calculate correlations
for (i in 1:nrow(industry_division_df)) {
  # Extract industry division name and data
  industry_division <- industry_division_df$industry_division[i]
  industry_data <- industry_division_df[i, -1]  # Skip the industry division name
  
  # Get the year columns from both datasets
  colnames_industry <- colnames(industry_data)
  colnames_agency <- colnames(agency_of_injury_df[, -1])  # Skip the first column

  # Align the columns by matching year ranges
  common_years <- intersect(colnames_industry, colnames_agency)
  
  # Subset both datasets to include only the common years
  industry_data_aligned <- industry_data[, common_years, drop = FALSE]
  agency_data_aligned <- agency_of_injury_df[, c("agency_of_injury", common_years), drop = FALSE]
  
  # Transpose the industry data into a numeric vector
  industry_data_t <- as.numeric(unlist(industry_data_aligned))
  
  # Calculate correlations for each agency_of_injury
  correlations <- apply(agency_data_aligned[, -1, drop = FALSE], 1, function(x) {
    cor(as.numeric(x), industry_data_t, use = "complete.obs")
  })
  
  # Add the correlations to the dataframe, using the industry division name as the column name
  industry_agency_correlation_df[[industry_division]] <- correlations
}

# View the final correlation dataframe
head(industry_agency_correlation_df)
```

As the dataset is large for the correlation analysis, we will select a subset of the data to perform the analysis. The subset will be selected based on the top 12 corelation values between the Industry Division and Agency of Injury.

```{r}
# Filter out top 12 data with largest correlation score
top_correlation <- industry_agency_correlation_df %>%
  gather(key = "industry_division", value = "correlation", -agency_of_injury) %>%
  group_by(industry_division) %>%
  top_n(12, correlation) %>%
  arrange(desc(correlation))

head(top_correlation)
```

```{r}
# Initialize an empty list to store the plot data for each iteration
plot_data_list <- list()

# Loop through top 12 correlations and collect data
for (i in 1:12) {
    industry_division <- top_correlation$industry_division[i]
    agency_of_injury <- top_correlation$agency_of_injury[i]
    correlation <- top_correlation$correlation[i]

    # Extract the industry data for the specific industry division
    industry_data <- industry_division_df[industry_division_df$industry_division == industry_division, -1]

    # Extract the agency data for the specific agency_of_injury, removing the first two columns
    agency_data <- agency_of_injury_df[agency_of_injury_df$agency_of_injury == agency_of_injury, -(1:2)]

    # Create a data frame for each combination
    years <- 2011:2023
    plot_data <- data.frame(
        Year = years,
        Industry_Claims = as.numeric(unlist(industry_data)),
        Agency_Claims = as.numeric(unlist(agency_data)),
        Industry_Division = industry_division,
        Agency_of_Injury = agency_of_injury
    )

    # Store the plot data for this iteration in the list
    plot_data_list[[i]] <- plot_data
}

# Combine all the collected plot data into a single dataframe
final_plot_data <- do.call(rbind, plot_data_list)

head(final_plot_data)
```

```{r, fig.width=12, fig.height=12}
custom_labeller <- labeller(
    Industry_Division = function(x) str_wrap(x, width = 20),  # Wrap industry names
    Agency_of_Injury = function(x) str_wrap(x, width = 20)    # Wrap agency names
)

# Create the ggplot with text wrapping in facet labels
ggplot(data = final_plot_data, aes(x = Year)) +
    geom_line(aes(y = Industry_Claims, color = "Industry Claims"), size = 1.2) +
    geom_point(aes(y = Industry_Claims, color = "Industry Claims")) +
    geom_line(aes(y = Agency_Claims, color = "Agency Claims"), size = 1.2) +
    geom_point(aes(y = Agency_Claims, color = "Agency Claims")) +
    facet_wrap(~ Industry_Division + Agency_of_Injury, scales = "free_y", labeller = custom_labeller) +  # Apply custom labeller
    labs(
        title = "Claims over the years for Industry Divisions and Agencies of Injury",
        x = "Year",
        y = "Number of Claims"
    ) +
    scale_color_manual(name = "Claims", values = c("Industry Claims" = "blue", "Agency Claims" = "red")) +
    theme_minimal() +
    theme(
        plot.title = element_text(size = 14),
        axis.title = element_text(size = 12),
        axis.text = element_text(size = 10),
        strip.text = element_text(size = 12),
        legend.title = element_text(size = 10),
        legend.text = element_text(size = 9)
    ) +
    theme(plot.margin = unit(c(1, 1, 1, 1), "cm")) 
```

From the plotting, we can observe some combinations of Industry Division and Agency of Injury that have a very similar plot pattern. We will select one of the combination to perform further analysis.

We will select the combination of `Public Admisnistration and Safety` and `Indoor Environment` for detailed analysis.

```{r}
# Create a subset of the subset plot data for the specific industry division and agency of injury
subset_plot_data <- final_plot_data %>%
    filter(Industry_Division %in% c("Public Administration and Safety"),
           Agency_of_Injury %in% c("Indoor Environment"))

# Function to calculate the R-squared value for a linear model
calculate_r_squared <- function(x, y) {
    model <- lm(y ~ x)
    summary(model)$r.squared
}

# Calculate R-squared values for Industry Claims
industry_r_squared <- calculate_r_squared(subset_plot_data$Year, subset_plot_data$Industry_Claims)

# Calculate R-squared values for Agency Claims
agency_r_squared <- calculate_r_squared(subset_plot_data$Year, subset_plot_data$Agency_Claims)

# Create the ggplot with text wrapping in facet labels and linear regression lines
ggplot(data = subset_plot_data, aes(x = Year)) +
    geom_line(aes(y = Industry_Claims, color = "Public Administration and Safety"), size = 1.2) +
    geom_point(aes(y = Industry_Claims, color = "Public Administration and Safety")) +
    geom_smooth(aes(y = Industry_Claims, color = "Public Administration and Safety"), method = "lm", linetype = "dashed", se = FALSE) +
    geom_line(aes(y = Agency_Claims, color = "Indoor Environment Claims"), size = 1.2) +
    geom_point(aes(y = Agency_Claims, color = "Indoor Environment Claims")) +
    geom_smooth(aes(y = Agency_Claims, color = "Indoor Environment Claims"), method = "lm", linetype = "dashed", se = FALSE) +
    facet_wrap(~ Industry_Division + Agency_of_Injury, scales = "free_y") +  
    labs(
        title = "Claims over the years for",
        x = "Year",
        y = "Number of Claims"
    ) +
    # Annotate the R-squared values on the plot
    annotate("text", x = 2015, y = max(subset_plot_data$Industry_Claims, na.rm = TRUE) * 0.9, 
             label = paste("R² for Public Administration $ Safety:", round(industry_r_squared, 2)), color = "blue", size = 3) +
    annotate("text", x = 2015, y = max(subset_plot_data$Agency_Claims, na.rm = TRUE) * 0.8, 
             label = paste("R² for Indoor Environment Claims:", round(agency_r_squared, 2)), color = "red", size = 3) +
    scale_color_manual(name = "Claims", values = c("Public Administration and Safety" = "blue", "Indoor Environment Claims" = "red")) +
    theme_minimal() +
    theme(
        plot.title = element_text(size = 14),
        axis.title = element_text(size = 12),
        axis.text = element_text(size = 10),
        strip.text = element_text(size = 12),
        legend.title = element_text(size = 10),
        legend.text = element_text(size = 9)
    ) +
    theme(plot.margin = unit(c(1, 1, 1, 1), "cm"))

```

The graph above displays one of top combinations, showing the relationship between **Public Administration and Safety** and **Indoor Environment** injuries. The **R² values** for both **Industry Claims** (0.73) and **Agency Claims** (0.6) indicate a relatively strong correlation, suggesting that the trend of injury claims in this industry closely aligns with incidents occurring in indoor environments.

### 8.0 ARIMA Model Prediction

From previous sections, it shows that the `Public Administration and Safety` sector and `Indoor Environment` agency have a strong correlation. We will take in `Outdoor Environment` agency as a comparison and make a ARIMA model prediction.

```{r}
# Step 1: Create a combined dataset with selected industries and agencies of injury
selected_prediction_data <- industry_division_df %>%
  filter(industry_division == "Public Administration and Safety") %>%
  rename_with(~c("Injury Source", "2011", "2012", "2013", "2014", "2015", "2016", 
                 "2017", "2018", "2019", "2020", "2021", "2022", "2023"))

# Step 2: Extract the relevant agencies of injury and rename columns in one step
selected_prediction_data_2 <- agency_of_injury_df %>%
  filter(agency_of_injury %in% c("Indoor Environment", "Outdoor Environment")) %>%
  select(-agency_of_injury_type) %>%  # Drop the unnecessary column
  rename_with(~c("Injury Source", "2011", "2012", "2013", "2014", "2015", "2016", 
                 "2017", "2018", "2019", "2020", "2021", "2022", "2023"))

# Step 3: Combine the datasets into a single data frame
combined_prediction_data <- bind_rows(selected_prediction_data, selected_prediction_data_2)

# Display the combined dataset
combined_prediction_data
```

```{r}
# Create an empty data frame to store all the forecasted and actual data for plotting
plot_prediction_data <- data.frame()

# Loop through each injury source to fit the ARIMA model and store the results
for (i in 1:nrow(combined_prediction_data)) {
  injury_source <- combined_prediction_data$`Injury Source`[i]
  time_series_data <- ts(as.numeric(combined_prediction_data[i, -1]), start = 2011, frequency = 10)

  arima_model <- auto.arima(
    time_series_data, 
    d = 2,
    stepwise = TRUE,
    approximation = FALSE, 
    allowdrift = TRUE 
  )

  # Forecast the next 5 years
  forecasted_values <- forecast(arima_model, h = 5)

  # Combine actual and forecasted data into a single data frame
  temp_data <- data.frame(
    Year = c(2011:2023, 2024:(2023 + 5)),
    Claims = c(as.numeric(time_series_data), as.numeric(forecasted_values$mean)),
    Type = c(rep("Actual", length(time_series_data)), rep("Forecast", 5)),
    Injury_Source = injury_source
  )

  # Add the data to the main plot data frame
  plot_prediction_data <- rbind(plot_prediction_data, temp_data)
}
```

```{r}
# Visualize the results
ggplot(data = plot_prediction_data, aes(x = Year, y = Claims, color = Injury_Source)) +
  geom_line(aes(linetype = Type), size = 1) +
  labs(
    title = "Forecasted Injury Claims with ARIMA Model",
    x = "Year",
    y = "Number of Claims"
  ) +
  theme_minimal() +
  scale_linetype_manual(values = c("Actual" = "solid", "Forecast" = "dashed")) +
  scale_color_manual(values = c("red","#0c640c", "blue")) # Adjust colors as needed
```

The forecasted results above illustrate that injury claims in Indoor Environments and the Public Administration and Safety sector are expected to increase, while claims in Outdoor Environments are forecasted to decrease in the coming years.

This insight suggests that if a customer works in the Public Administration and Safety sector and operates in Indoor Environments, insurance companies to consider raising the insurance premium to reflect the higher risk.

In contrast, for customers in the same industry but working in Outdoor Environments, the insurance premium can likely be maintained, as the forecast shows a decrease in injury claims over the coming years.

```{r}

```
